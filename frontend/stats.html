<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visitor Analytics - Smart Resume</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            text: '#f8fafc',
                            accent: '#38bdf8'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0f172a;
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="p-6 md:p-12">

    <div class="max-w-6xl mx-auto space-y-8">

        <!-- Header -->
        <header class="flex justify-between items-center border-b border-gray-700 pb-4">
            <div>
                <h1
                    class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">
                    Visitor Analytics
                </h1>
                <p class="text-gray-400 text-sm mt-1">Real-time engagement metrics</p>
            </div>
            <a href="/" class="text-sm text-blue-400 hover:text-blue-300 transition">‚Üê Back to Resume</a>
        </header>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-lg">
                <h3 class="text-gray-400 text-sm uppercase font-semibold tracking-wider">Total Visits</h3>
                <p id="totalVisits" class="text-4xl font-bold text-white mt-2">-</p>
            </div>
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-lg">
                <h3 class="text-gray-400 text-sm uppercase font-semibold tracking-wider">Unique Visitors</h3>
                <p id="uniqueBase" class="text-4xl font-bold text-emerald-400 mt-2">-</p>
            </div>
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-lg">
                <h3 class="text-gray-400 text-sm uppercase font-semibold tracking-wider">Last Active</h3>
                <p id="lastActive" class="text-xl font-medium text-blue-300 mt-2">-</p>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-lg">
            <h3 class="text-lg font-semibold mb-4 text-gray-200">Visits Timeline</h3>
            <div class="relative w-full h-64">
                <canvas id="visitsChart"></canvas>
            </div>
        </div>

        <!-- Recent Table -->
        <div class="bg-gray-800 rounded-xl overflow-hidden border border-gray-700 shadow-lg">
            <div class="p-6 border-b border-gray-700">
                <h3 class="text-lg font-semibold text-gray-200">Recent Activity</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm text-gray-400">
                    <thead class="bg-gray-900/50 text-gray-200 uppercase text-xs">
                        <tr>
                            <th class="px-6 py-3">Time</th>
                            <th class="px-6 py-3">Location</th>
                            <th class="px-6 py-3">Device / OS</th>
                            <th class="px-6 py-3 text-right">Visits</th>
                        </tr>
                    </thead>
                    <tbody id="visitsTable" class="divide-y divide-gray-700">
                        <tr>
                            <td colspan="4" class="px-6 py-8 text-center">Loading data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        const API_URL = 'https://uyoqj8v54k.execute-api.us-east-1.amazonaws.com/stats';

        async function init() {
            try {
                const res = await fetch(API_URL);
                if (!res.ok) throw new Error('API Error');
                const data = await res.json();
                render(data);
            } catch (err) {
                console.error(err);
                document.getElementById('visitsTable').innerHTML = `
                    <tr><td colspan="4" class="px-6 py-4 text-center text-red-400">Failed to load stats.</td></tr>
                `;
            }
        }

        function render(data) {
            const items = data.items || [];

            // 1. KPIs
            document.getElementById('totalVisits').innerText = items.length; // Approximate for MVP
            const unique = new Set(items.map(i => i.visitorId)).size;
            document.getElementById('uniqueBase').innerText = unique;

            if (items.length > 0) {
                const last = new Date(items[0].lastUpdated);
                document.getElementById('lastActive').innerText = timeAgo(last);
            }

            // 2. Table
            const tbody = document.getElementById('visitsTable');
            tbody.innerHTML = items.slice(0, 20).map(item => `
                <tr class="hover:bg-gray-700/30 transition">
                    <td class="px-6 py-4 whitespace-nowrap">${formatDate(item.lastUpdated)}</td>
                    <td class="px-6 py-4">
                        <span class="flex items-center gap-2">
                            ${item.country !== 'Unknown' ? 'üåç' : '‚ùì'}
                            ${item.city || 'Unknown'}, ${item.country || 'Unknown'}
                        </span>
                    </td>
                    <td class="px-6 py-4 truncate max-w-xs" title="${item.userAgent}">
                        ${parseUA(item.userAgent)}
                    </td>
                    <td class="px-6 py-4 text-right font-mono text-emerald-400">#${item.visitCount || 1}</td>
                </tr>
            `).join('');

            // 3. Chart (Group by Date)
            renderChart(items);
        }

        function renderChart(items) {
            const ctx = document.getElementById('visitsChart').getContext('2d');

            // Group by Day
            const counts = {};
            items.forEach(item => {
                const date = new Date(item.lastUpdated).toLocaleDateString();
                counts[date] = (counts[date] || 0) + 1;
            });

            const labels = Object.keys(counts).reverse(); // Oldest first
            const values = Object.values(counts).reverse();

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Visits',
                        data: values,
                        borderColor: '#38bdf8',
                        backgroundColor: 'rgba(56, 189, 248, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#334155' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // --- Helpers ---
        function formatDate(iso) {
            return new Date(iso).toLocaleString('en-US', {
                month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });
        }

        function timeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " mins ago";
            return "Just now";
        }

        function parseUA(ua) {
            if (!ua) return 'Unknown';
            if (ua.includes('iPhone')) return 'iPhone';
            if (ua.includes('Android')) return 'Android';
            if (ua.includes('Mac')) return 'Mac OS';
            if (ua.includes('Windows')) return 'Windows';
            return 'Other';
        }

        init();
    </script>
</body>

</html>